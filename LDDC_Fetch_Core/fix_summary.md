# LRC → TTML 转换修复总结

## 修复的问题

### 问题 1：歌曲额外信息未被过滤
**原因**: 之前移除了 `-`, `/`, `&`, `%`, `\` 等单字符关键词，导致含有制作信息的行无法被识别。  
**修复**: 恢复这些符号在 `is_song_info_line()` 中，**仅用于原歌词过滤**。翻译行不做此匹配。

### 问题 2：翻译行被误删
**原因**: `is_song_info_line()` 的 regex 中存在尾部空 alternation `(?:词|曲|)`，导致任何含冒号的文本（包括时间戳残留 `[xx:xx.xxx]` 中的冒号）都被误判为元数据。  
**修复**:  
- 移除 regex 尾部空 alternation（`(?:词|曲|)` → `(?:词|曲)`）
- 翻译行**不再使用** `is_song_info_line()`
- 翻译行仅根据原歌词被删除行的**时间戳**进行对应删除
- 翻译行仅过滤版权声明（`QQ音乐享有本翻译作品的著作权` 等）

### 问题 3：翻译文本末尾时间戳残留
**原因**: 翻译 LRC 行格式为 `[00:02.654]倘若无人观看会怎么样呢[00:05.870]`，regex `r'\[(\d+:\d+\.\d+)\](.+)'` 会捕获末尾时间戳作为文本的一部分。  
**修复**: 新增 `strip_trailing_timestamps()` 函数，用 `re.sub(r'\[\d+:\d+\.\d+\]\s*$', '', text)` 移除末尾时间戳。

## 关键设计决策

| 面向对象 | 过滤策略 |
|---------|---------|
| 原歌词行 | `is_song_info_line()` 全量匹配（含 `-/&%\` 等符号） |
| 翻译行 | 仅过滤版权声明 + 根据原歌词被删行的时间戳同步删除 |

## 修改的文件

- `lrc_to_ttml_with_translation.py` — 主要修复
- `lrc_to_ttml.py` — 恢复 `-/&%\` 关键词

## 测试结果（5 个文件）

| 文件 | 歌词行数 | 翻译行数 | 残留时间戳 | 状态 |
|------|---------|---------|-----------|------|
| AREA21 - Followers | 78 | 58 | 0 | ✅ |
| Bastille/Ella - No Angels | 64 | 57 | 0 | ✅ |
| DOUDOU - 超度我 | 57 | 0 (纯中文) | - | ✅ |
| John Powell - Together from Afar | 30 | 30 | 0 | ✅ |
| mgk/GLAIVE - more than life | 51 | 46 | 0 | ✅ |

## 文件位置

- **拆分 LRC**: `test_convert/split/` — 保留 `_ori.lrc` 和 `_trans.lrc`
- **最终 TTML**: `test_convert/output/` — 已验证无问题的 TTML 文件
